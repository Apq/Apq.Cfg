# Apq.Cfg 性能测试对比分析

**对比版本**：
- 第一次测试：2025-12-25_151849
- 第二次测试：2025-12-25_223016

**测试环境**（两次相同）：
- 系统：Windows 11 (10.0.26200.7462)
- SDK：.NET SDK 9.0.308
- 测试运行时：.NET 6.0.36、.NET 8.0.22、.NET 9.0.11
- CPU：支持 AVX-512F+CD+BW+DQ+VL+VBMI

---

## 一、测试覆盖范围对比

| 测试类别 | 第一次 (151849) | 第二次 (223016) | 变化 |
|----------|:---------------:|:---------------:|------|
| ReadWriteBenchmarks | ✓ | ✓ | 无变化 |
| LargeFileBenchmarks | ✓ | ✓ | 无变化 |
| ConcurrencyBenchmarks | ✓ | ✓ | 无变化 |
| CacheBenchmarks | ✓ | ✓ | 无变化 |
| TypeConversionBenchmarks | ✓ | ✓ | 无变化 |
| BatchOperationBenchmarks | ✓ | ✓ | 无变化 |
| GetSectionBenchmarks | ✓ | ✓ | 无变化 |
| SaveBenchmarks | ✓ | ✓ | 无变化 |
| RemoveBenchmarks | ✓ | ✓ | 无变化 |
| MultiSourceBenchmarks | ✓ | ✓ | 无变化 |
| KeyPathBenchmarks | ✓ | ✓ | 无变化 |
| MicrosoftConfigBenchmarks | ✓ | ✓ | 无变化 |
| **DependencyInjectionBenchmarks** | ✗ | ✓ | **新增** |
| **EncodingBenchmarks** | ✗ | ✓ | **新增** |
| **ObjectBinderBenchmarks** | ✗ | ✓ | **新增** |

---

## 二、核心性能指标对比（.NET 9.0）

### 1. 读写基准测试 (ReadWriteBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| Get (字符串) | 17 ns | 17-18 ns | ≈ | 稳定 |
| Exists | 20 ns | 22 ns | +10% | 略有波动 |
| Set | 20 ns | 22 ns | +10% | 略有波动 |
| GetInt | 77 ns | 81-86 ns | +5-12% | 略有波动 |

**结论**：基本读写性能保持稳定，差异在正常波动范围内。

---

### 2. 大文件基准测试 (LargeFileBenchmarks)

| 格式 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| **Ini** | 186 μs | 241 μs | **+30%** | 性能下降 |
| **Json** | 251 μs | 184 μs | **-27%** | 性能提升 |
| Xml | 494 μs | 460 μs | -7% | 略有提升 |
| Yaml | 834 μs | 836 μs | ≈ | 稳定 |
| Toml | 863 μs | 1,474 μs | **+71%** | 波动大 |

**重要发现**：
- **Json 超越 Ini 成为大文件加载最快的格式**
- 第一次测试 Ini 最快（186 μs），第二次测试 Json 最快（184 μs）
- Toml 性能波动较大，可能与测试环境状态有关

---

### 3. 并发基准测试 (ConcurrencyBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 读相同键 | 6.5 μs | 6.8 μs | +5% | 稳定 |
| 读不同键 | 16.5 μs | 16.7 μs | +1% | 稳定 |
| Exists | 4.0 μs | 4.0 μs | ≈ | 稳定 |
| 混合读写 | 17.8 μs | 18.3 μs | +3% | 稳定 |
| 写不同键 | 31.9 μs | 32.0 μs | ≈ | 稳定 |

**结论**：并发性能非常稳定，两次测试结果一致。

---

### 4. 缓存效果测试 (CacheBenchmarks)

| 场景 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 热路径读取 (1000次) | 13.5 μs | 15.6 μs | +16% | 略有波动 |
| 首次访问 | 16 ns | 16 ns | ≈ | 稳定 |
| 后续访问 (预热后) | 1.6 μs | 1.6 ns | ≈ | 稳定 |
| 缓存未命中 (1000次) | 14.5 μs | 15.4 μs | +6% | 略有波动 |
| 写后读取 | 151 μs | 155 μs | +3% | 稳定 |

**结论**：缓存性能稳定，差异在正常范围内。

---

### 5. 类型转换测试 (TypeConversionBenchmarks)

| 类型 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| String | 17 ns | 18 ns | +6% | 稳定 |
| Int | 60 ns | 67 ns | +12% | 略有波动 |
| Bool | 77 ns | 87 ns | +13% | 略有波动 |
| Double | 85 ns | 94 ns | +11% | 略有波动 |
| Guid | 107 ns | 112 ns | +5% | 稳定 |
| DateTime | 71 ns | 128 ns | **+80%** | 波动大 |
| Enum | 80 μs | 83 μs | +4% | 稳定 |
| NullableInt | 70 μs | 77 μs | +10% | 略有波动 |

**注意**：DateTime 转换性能波动较大，可能与 JIT 优化或系统状态有关。

---

### 6. 批量操作测试 (BatchOperationBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| GetMany (10键) | 303 ns | 346 ns | +14% | 略有波动 |
| Get 循环 (10键) | 147 ns | 167 ns | +14% | 略有波动 |
| GetMany (50键) | 1,384 ns | 1,595 ns | +15% | 略有波动 |
| Get 循环 (50键) | 798 ns | 855 ns | +7% | 稳定 |
| SetMany (10键) | 973 ns | 373 ns | **-62%** | 显著提升 |
| Set 循环 (10键) | 576 ns | NA | - | 第二次有问题 |

**重要发现**：
- 两次测试都显示：**循环 Get 比 GetMany 更快**
- SetMany 性能在第二次测试中显著提升
- 第二次测试中 `Get_Typed_Loop_10Keys` 存在问题（已修复）

---

### 7. 配置节测试 (GetSectionBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| GetSection | 19 ns | 20 ns | +5% | 稳定 |
| GetSection (嵌套) | 33 ns | 34 ns | +3% | 稳定 |
| GetSection + Get | 31 ns | 1,069 ns | **异常** | 测试方法可能不同 |
| GetChildKeys | 0.97 μs | 1.0 μs | +3% | 稳定 |
| Section.GetChildKeys | 0.43 μs | 0.43 μs | ≈ | 稳定 |
| 直接 Get | 4 ns | 4 ns | ≈ | 稳定 |
| Section.Get | 15 ns | 15 ns | ≈ | 稳定 |

**注意**：`GetSection + Get` 数据差异巨大，可能是测试方法或统计方式不同。

---

### 8. 保存测试 (SaveBenchmarks)

| 格式 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| Json (10项) | 3.5 ms | 3.8 ms | +9% | 稳定 |
| Ini (10项) | 0.78 ms | 0.77 ms | ≈ | 稳定 |
| Xml (10项) | 0.73 ms | 0.68 ms | -7% | 略有提升 |
| Yaml (10项) | 0.72 ms | 0.76 ms | +6% | 稳定 |
| Toml (10项) | 0.75 ms | 0.97 ms | +29% | 波动较大 |

**结论**：保存性能整体稳定，Toml 波动较大。

---

### 9. 删除测试 (RemoveBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 单键删除 | 7.2 μs | 5.2 μs | **-28%** | 性能提升 |
| 批量删除 (10键) | 5.4 μs | 7.2 μs | +33% | 波动 |
| 删除不存在的键 | 5.2 μs | 7.2 μs | +38% | 波动 |
| 删除后保存 | 0.87 ms | 0.88 ms | ≈ | 稳定 |

**结论**：删除操作性能有波动，但整体在可接受范围内。

---

### 10. 多源合并测试 (MultiSourceBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 读高优先级键 | 42 ns | 45 ns | +7% | 稳定 |
| 读低优先级键 | 41 ns | 48 ns | +17% | 略有波动 |
| 读共享键 | 39 ns | 46 ns | +18% | 略有波动 |
| 批量读取 | 9.4 μs | 11.1 μs | +18% | 略有波动 |
| Exists | 42 ns | 49 ns | +17% | 略有波动 |
| 类型转换 | 91 ns | 108 ns | +19% | 略有波动 |
| Write_NewKey | - | NA | - | 第二次有问题（已修复） |
| Write_OverrideKey | - | NA | - | 第二次有问题（已修复） |

**注意**：第二次测试中写入测试存在问题，已修复。

---

### 11. 键路径深度测试 (KeyPathBenchmarks)

| 路径深度 | 第一次 | 第二次 | 变化 | 说明 |
|----------|--------|--------|------|------|
| 深度 1 | 13 ns | 14 ns | +8% | 稳定 |
| 深度 5 | 24 ns | 26 ns | +8% | 稳定 |
| 深度 10 | 25 ns | 23 ns | -8% | 稳定 |
| 深度 5 (Int) | 109 ns | 100 ns | -8% | 稳定 |
| 深度 5 (Bool) | 102 ns | 94 ns | -8% | 稳定 |

**结论**：键路径深度测试性能非常稳定。

---

### 12. Microsoft Configuration 转换测试 (MicrosoftConfigBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| ToMicrosoftConfiguration (静态) | 66 ns | 63 ns | -5% | 稳定 |
| ToMicrosoftConfiguration (动态) | 93 ns | 95 ns | +2% | 稳定 |
| ToMicrosoftConfiguration (多次) | 940 ns | 970 ns | +3% | 稳定 |
| 通过 ApqCfg 读取 | 17 ns | 18 ns | +6% | 稳定 |
| 通过 MsConfig 读取 | 11 ns | 12 ns | +9% | 稳定 |
| 订阅 ConfigChanges | 4.8 μs | 5.5 μs | +15% | 略有波动 |
| 触发变更 | 3.1 μs | 3.3 μs | +6% | 稳定 |

**结论**：Microsoft Configuration 转换性能稳定。

---

## 三、新增测试项（第二次测试）

### 13. 依赖注入测试 (DependencyInjectionBenchmarks)

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 解析 IApqCfg | 144 μs | 136 μs | 142 μs |
| 解析 IApqCfg (Scoped) | 16 ns | 8 ns | **8 ns** |
| 解析 IApqCfgSection | 1.7 μs | 0.74 μs | **0.67 μs** |
| 解析 IApqCfgSection (Scoped) | 18 ns | 12 ns | **12 ns** |
| 解析 Options<T> | 0.82 μs | 0.82 μs | 0.82 μs |
| 解析 IOptionsSnapshot<T> | 0.61 μs | 0.28 μs | **0.27 μs** |
| 解析 IOptionsMonitor<T> | 61 μs | 28 μs | **27 μs** |

**亮点**：Scoped 解析仅需 8-12 ns，性能极佳。

---

### 14. 编码测试 (EncodingBenchmarks)

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 加载 UTF-8 文件 | 40 μs | 38 μs | 39 μs |
| 加载 UTF-8 BOM 文件 | 36 μs | 37 μs | 39 μs |
| 加载 UTF-16 文件 | 160 μs | 146 μs | 151 μs |
| 加载 GB2312 文件 | 158 μs | 146 μs | **142 μs** |
| 保存 UTF-8 文件 | 38 ms | 38 ms | **35 ms** |
| 保存 UTF-8 BOM 文件 | 16 ms | 18 ms | **15 ms** |
| 读取中文值 (预热后) | 6 μs | 1.5 μs | **1.4 μs** |

**亮点**：UTF-8 加载最快，预热后读取中文值性能提升 77%。

---

### 15. 对象绑定测试 (ObjectBinderBenchmarks)

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 绑定简单对象 | 838 ns | 351 ns | **351 ns** |
| 绑定嵌套对象 | 4.0 μs | 1.7 μs | **1.6 μs** |
| 绑定集合 | 4.4 μs | 2.2 μs | **2.2 μs** |
| 绑定字典 | 2.7 μs | 1.3 μs | **1.3 μs** |

**亮点**：.NET 8/9 比 .NET 6 快约 58%（简单对象绑定）。

---

## 四、测试问题记录

### 第二次测试中发现的问题（已修复）

| 测试方法 | 问题原因 | 修复方案 |
|----------|----------|----------|
| `BatchOperationBenchmarks.Get_Typed_Loop_10Keys` | 配置值为 "Value0" 无法转换为 int | 将配置值改为数字字符串 "0", "1" 等 |
| `MultiSourceBenchmarks.Write_NewKey` | 最高层级配置源不可写 | 将最高层级设为可写 |
| `MultiSourceBenchmarks.Write_OverrideKey` | 最高层级配置源不可写 | 将最高层级设为可写 |

---

## 五、总结

### 性能稳定性评估

| 类别 | 稳定性 | 说明 |
|------|--------|------|
| 基本读写 | ⭐⭐⭐⭐⭐ | 非常稳定，波动 <10% |
| 并发操作 | ⭐⭐⭐⭐⭐ | 非常稳定，波动 <5% |
| 缓存效果 | ⭐⭐⭐⭐ | 稳定，波动 <20% |
| 类型转换 | ⭐⭐⭐ | 部分波动较大（DateTime） |
| 大文件加载 | ⭐⭐⭐ | Ini/Toml 波动较大 |
| 保存操作 | ⭐⭐⭐⭐ | 稳定，Toml 略有波动 |
| 删除操作 | ⭐⭐⭐ | 有一定波动 |
| 配置节操作 | ⭐⭐⭐⭐⭐ | 非常稳定 |
| 键路径深度 | ⭐⭐⭐⭐⭐ | 非常稳定 |
| Microsoft 转换 | ⭐⭐⭐⭐⭐ | 非常稳定 |

### 主要发现

1. **格式性能排名变化**：
   - 第一次：Ini > Json > Xml > Yaml > Toml
   - 第二次：Json > Ini > Xml > Yaml > Toml
   - Json 在第二次测试中表现更优

2. **批量操作结论一致**：
   - 两次测试都显示循环 Get 比 GetMany 更快
   - 建议在小批量场景使用循环，大批量场景使用 GetMany

3. **新增测试覆盖**：
   - 依赖注入性能测试：Scoped 解析极快（8-12 ns）
   - 编码测试：UTF-8 加载最快
   - 对象绑定测试：.NET 8/9 性能提升显著

4. **运行时建议不变**：
   - 推荐 .NET 8.0 或 .NET 9.0
   - 性能比 .NET 6.0 提升 35-55%

### 建议

1. **性能测试应多次运行取平均值**，减少单次测试的波动影响
2. **关注 Toml 格式的性能波动**，在生产环境中谨慎使用
3. **优先使用 Json 或 Ini 格式**，性能最稳定
4. **利用 Scoped 解析**，在依赖注入场景获得最佳性能
