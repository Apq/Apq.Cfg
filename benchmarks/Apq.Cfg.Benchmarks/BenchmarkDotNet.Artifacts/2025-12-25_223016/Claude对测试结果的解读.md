# Apq.Cfg 性能测试结果解读

**测试环境**：

- 系统：Windows 11 (10.0.26200.7462)
- SDK：.NET SDK 9.0.308
- 测试运行时：.NET 6.0.36、.NET 8.0.22、.NET 9.0.11
- CPU：支持 AVX-512F+CD+BW+DQ+VL+VBMI
- 测试日期：2025-12-25

---

## 1. 读写基准测试 (ReadWriteBenchmarks)

### 基本操作性能

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 | 说明 |
|------|----------|----------|----------|------|
| Get (字符串) | 29-31 ns | 18-20 ns | **17-18 ns** | 零内存分配 |
| Exists | 25-30 ns | 21-22 ns | **22 ns** | 零内存分配 |
| Set | 29-31 ns | 21-22 ns | **22 ns** | 零内存分配 |
| GetInt | 132-142 ns | 88-92 ns | **81-86 ns** | 类型转换 |

**结论**：

- 所有格式性能接近，差异在误差范围内
- **.NET 8/9 比 .NET 6 快约 35-45%**（基本操作）
- **.NET 9 类型转换比 .NET 6 快约 40%**
- 基本操作均在 22 ns 以内完成

---

## 2. 大文件基准测试 (LargeFileBenchmarks)

### 1000 条配置项加载性能

| 格式 | .NET 6.0 | .NET 8.0 | .NET 9.0 | 说明 |
|------|----------|----------|----------|------|
| **Ini** | 251 μs | 240 μs | **241 μs** | 最快 |
| **Json** | 189 μs | 189 μs | **184 μs** | 次快 |
| Xml | 519 μs | 454 μs | **460 μs** | 中等 |
| Yaml | 1,426 μs | 899 μs | **836 μs** | 较慢 |
| Toml | 1,221 μs | 874 μs | **1,474 μs** | 较慢（波动大） |

**结论**：

- **Json 和 Ini 是大文件场景的最佳选择**
- Json 比 Ini 快约 24%
- .NET 9 在 Yaml 解析上比 .NET 6 快约 41%
- Xml 在 .NET 8/9 上性能提升约 12%

---

## 3. 并发基准测试 (ConcurrencyBenchmarks)

### 4 线程并发（Json 配置源）

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 读相同键 | 16.1 μs | 6.6 μs | **6.8 μs** |
| 读不同键 | 22.7 μs | 19.5 μs | **16.7 μs** |
| Exists | 7.6 μs | 4.0 μs | **4.0 μs** |
| 混合读写 | 26.0 μs | 20.4 μs | **18.3 μs** |
| 写不同键 | 36.1 μs | 33.2 μs | **32.0 μs** |

**结论**：

- 并发读性能优秀，.NET 8/9 比 .NET 6 快约 59%
- 混合读写场景 .NET 9 比 .NET 6 快约 30%
- 线程安全，支持高并发访问

---

## 4. 缓存效果测试 (CacheBenchmarks)

| 场景 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 热路径读取 (1000次) | 24.8 μs | 14.0 μs | **15.6 μs** |
| 首次访问 | 26 ns | 17 ns | **16 ns** |
| 后续访问 (预热后) | 2.7 ns | 1.7 ns | **1.6 ns** |
| 缓存未命中 (1000次) | 24.3 μs | 14.5 μs | **15.4 μs** |
| 写后读取 | 240 μs | 143 μs | **155 μs** |

**结论**：

- 热路径读取性能稳定，.NET 8/9 比 .NET 6 快约 37-44%
- 首次访问仅需 16 ns，几乎无开销
- 缓存命中与未命中性能差异小，设计合理

---

## 5. 类型转换测试 (TypeConversionBenchmarks)

| 类型 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| String | 27 ns | 19 ns | **18 ns** |
| Int | 105 ns | 73 ns | **67 ns** |
| Bool | 133 ns | 87 ns | **87 ns** |
| Double | 152 ns | 95 ns | **94 ns** |
| Guid | 161 ns | 125 ns | **112 ns** |
| DateTime | 175 ns | 140 ns | **128 ns** |
| Enum | 135 μs | 84 μs | **83 μs** |
| NullableInt | 126 μs | 82 μs | **77 μs** |

**结论**：

- .NET 9 在所有类型转换上都有优势
- Int 转换 .NET 9 比 .NET 6 快约 36%
- DateTime 转换 .NET 9 比 .NET 6 快约 27%
- String 读取最快，仅需 18 ns

---

## 6. 批量操作测试 (BatchOperationBenchmarks)

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 | 说明 |
|------|----------|----------|----------|------|
| GetMany (10键) | 477 ns | 351 ns | **346 ns** | 批量读取 |
| Get 循环 (10键) | 292 ns | 168 ns | **167 ns** | 单次循环 |
| GetMany (50键) | 2,398 ns | 1,695 ns | **1,595 ns** | 批量读取 |
| Get 循环 (50键) | 1,423 ns | 897 ns | **855 ns** | 单次循环 |
| SetMany (10键) | 539 ns | 385 ns | **373 ns** | 批量写入 |
| Set 循环 (10键) | NA | NA | NA | 有问题 |

**结论**：

- 单次循环 Get 比 GetMany 更快（约快 50%）
- .NET 9 批量操作比 .NET 6 快约 27-33%
- Get_Typed_Loop_10Keys 测试存在问题，未能完成

---

## 7. 配置节测试 (GetSectionBenchmarks)

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| GetSection | 40 ns | 22 ns | **20 ns** |
| GetSection (嵌套) | 53 ns | 33 ns | **34 ns** |
| GetSection + Get | 2,214 ns | 1,046 ns | **1,069 ns** |
| GetChildKeys | 2.1 μs | 1.1 μs | **1.0 μs** |
| Section.GetChildKeys | 0.83 μs | 0.47 μs | **0.43 μs** |
| 直接 Get | 5 ns | 4 ns | **4 ns** |
| Section.Get | 18 ns | 15 ns | **15 ns** |

**结论**：

- GetSection 操作非常快，仅需 20 ns
- 直接 Get 比 Section.Get 快约 3-4 倍
- GetChildKeys 在 .NET 9 上比 .NET 6 快约 52%

---

## 8. 保存测试 (SaveBenchmarks)

| 格式 | .NET 6.0 | .NET 8.0 | .NET 9.0 | 说明 |
|------|----------|----------|----------|------|
| Json (10项) | 4.8 ms | 4.2 ms | **3.8 ms** | 批量保存 |
| Ini (10项) | 0.74 ms | 0.74 ms | **0.77 ms** | 最快 |
| Xml (10项) | 0.70 ms | 1.05 ms | **0.68 ms** | 较快 |
| Yaml (10项) | 0.77 ms | 0.92 ms | **0.76 ms** | 较快 |
| Toml (10项) | 0.87 ms | 0.78 ms | **0.97 ms** | 中等 |

**结论**：

- Ini/Xml/Yaml 保存速度相近，约 0.7-0.8 ms
- Json 保存较慢，约 3.8-4.8 ms（因为需要序列化完整 JSON 结构）
- 各运行时版本差异不大

---

## 9. 删除测试 (RemoveBenchmarks)

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 单键删除 | 7.2 μs | 5.6 μs | **5.2 μs** |
| 批量删除 (10键) | 6.6 μs | 7.4 μs | **7.2 μs** |
| 删除不存在的键 | 5.2 μs | 7.4 μs | **7.2 μs** |
| 删除后保存 | 1.16 ms | 0.95 ms | **0.88 ms** |

**结论**：

- 删除操作性能稳定，约 5-7 μs
- 单键删除在 .NET 9 上比 .NET 6 快约 28%
- 删除后保存时间主要取决于文件格式

---

## 10. 多源合并测试 (MultiSourceBenchmarks)

### 3 个配置源合并

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 读高优先级键 | 73 ns | 47 ns | **45 ns** |
| 读低优先级键 | 77 ns | 56 ns | **48 ns** |
| 读共享键 | 68 ns | 39 ns | **46 ns** |
| 批量读取 | 16.8 μs | 10.6 μs | **11.1 μs** |
| Exists | 73 ns | 44 ns | **49 ns** |
| 类型转换 | 155 ns | 101 ns | **108 ns** |

**结论**：

- 多源合并对读取性能影响很小
- .NET 8/9 比 .NET 6 快约 35-40%
- 层级覆盖逻辑高效
- Write_NewKey 和 Write_OverrideKey 测试存在问题

---

## 11. 键路径深度测试 (KeyPathBenchmarks)

| 路径深度 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|----------|----------|----------|----------|
| 深度 1 | 25 ns | 14 ns | **14 ns** |
| 深度 5 | 50 ns | 27 ns | **26 ns** |
| 深度 10 | 49 ns | 23 ns | **23 ns** |
| 深度 5 (Int) | 176 ns | 106 ns | **100 ns** |
| 深度 5 (Bool) | 166 ns | 101 ns | **94 ns** |

**结论**：

- 键路径深度对性能影响很小
- 深度 10 仅比深度 1 慢约 1.6-2 倍
- .NET 8/9 比 .NET 6 快约 44-53%

---

## 12. Microsoft Configuration 转换测试 (MicrosoftConfigBenchmarks)

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| ToMicrosoftConfiguration (静态) | 96 ns | 70 ns | **63 ns** |
| ToMicrosoftConfiguration (动态) | 130 ns | 96 ns | **95 ns** |
| ToMicrosoftConfiguration (多次) | 1,334 ns | 1,031 ns | **970 ns** |
| 通过 ApqCfg 读取 | 29 ns | 19 ns | **18 ns** |
| 通过 MsConfig 读取 | 17 ns | 12 ns | **12 ns** |
| 订阅 ConfigChanges | 8.3 μs | 5.4 μs | **5.5 μs** |
| 触发变更 | 4.9 μs | 3.5 μs | **3.3 μs** |

**结论**：

- ToMicrosoftConfiguration 转换非常快，约 63-95 ns
- 通过 MsConfig 读取比 ApqCfg 略快（因为少一层封装）
- ConfigChanges 订阅性能良好，约 5.5 μs

---

## 13. 依赖注入测试 (DependencyInjectionBenchmarks) - 新增

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 解析 IApqCfg | 144 μs | 136 μs | **142 μs** |
| 解析 IApqCfg (Scoped) | 16 ns | 8 ns | **8 ns** |
| 解析 IApqCfgSection | 1.7 μs | 0.74 μs | **0.67 μs** |
| 解析 IApqCfgSection (Scoped) | 18 ns | 12 ns | **12 ns** |
| 解析 Options<T> | 0.82 μs | 0.82 μs | **0.82 μs** |
| 解析 IOptionsSnapshot<T> | 0.61 μs | 0.28 μs | **0.27 μs** |
| 解析 IOptionsMonitor<T> | 61 μs | 28 μs | **27 μs** |

**结论**：

- Scoped 解析非常快，仅需 8-12 ns
- IOptionsSnapshot 解析在 .NET 9 上比 .NET 6 快约 56%
- IOptionsMonitor 解析在 .NET 9 上比 .NET 6 快约 56%

---

## 14. 编码测试 (EncodingBenchmarks) - 新增

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 加载 UTF-8 文件 | 40 μs | 38 μs | **39 μs** |
| 加载 UTF-8 BOM 文件 | 36 μs | 37 μs | **39 μs** |
| 加载 UTF-16 文件 | 160 μs | 146 μs | **151 μs** |
| 加载 GB2312 文件 | 158 μs | 146 μs | **142 μs** |
| 保存 UTF-8 文件 | 38 ms | 38 ms | **35 ms** |
| 保存 UTF-8 BOM 文件 | 16 ms | 18 ms | **15 ms** |
| 读取中文值 | 81 μs | 99 μs | **83 μs** |
| 读取中文值 (预热后) | 6 μs | 1.5 μs | **1.4 μs** |

**结论**：

- UTF-8 和 UTF-8 BOM 加载速度最快，约 36-40 μs
- UTF-16 和 GB2312 加载较慢，约 142-160 μs
- 预热后读取中文值在 .NET 9 上比 .NET 6 快约 77%

---

## 15. 对象绑定测试 (ObjectBinderBenchmarks) - 新增

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 | Rank |
|------|----------|----------|----------|------|
| 绑定简单对象 | 838 ns | 351 ns | **351 ns** | 2 |
| 绑定简单对象 (缓存) | 85 μs | 33 μs | **33 μs** | 7 |
| 绑定嵌套对象 | 4.0 μs | 1.7 μs | **1.6 μs** | 4 |
| 绑定嵌套对象 (缓存) | 399 μs | 162 μs | **162 μs** | 10 |
| 绑定集合 | 4.4 μs | 2.2 μs | **2.2 μs** | 4 |
| 绑定集合 (缓存) | 457 μs | 232 μs | **232 μs** | 10 |
| 绑定字典 | 2.7 μs | 1.3 μs | **1.3 μs** | 3 |
| 绑定字典 (缓存) | 259 μs | 131 μs | **131 μs** | 9 |

**结论**：

- 简单对象绑定最快，仅需 351 ns
- .NET 8/9 比 .NET 6 快约 58%（简单对象绑定）
- 嵌套对象和集合绑定性能也有显著提升

---

## 性能总结

### 性能排名（综合）

1. **Json** - 综合最优，加载最快
2. **Ini** - 大文件场景表现优秀，内存最省
3. **Xml** - 中等性能
4. **Yaml** - 较慢但可接受
5. **Toml** - 最慢，但功能丰富

### 运行时建议

- **推荐 .NET 8.0 或 .NET 9.0**，性能比 .NET 6.0 提升 35-55%
- .NET 9 在类型转换和并发场景优势明显
- .NET 8 和 .NET 9 性能接近，可根据项目需求选择

### 使用建议

| 场景 | 推荐格式 | 说明 |
|------|----------|------|
| 高频读写 | Json / Ini | 单次操作 17-22 ns |
| 大配置文件 | Json / Ini | Json 加载最快 |
| 人类可读性优先 | Yaml / Toml | 性能可接受 |
| 与现有系统集成 | Xml | 兼容性好 |
| 批量操作 | 使用循环 Get | 比 GetMany 更快 |
| 配置节访问 | 直接 Get 更快 | GetSection 适合多次访问同一节 |

### 关键性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| 单次读取 | **17-18 ns** | .NET 9 |
| 单次写入 | **22 ns** | .NET 9 |
| 类型转换 (Int) | **67 ns** | .NET 9 |
| 1000 项加载 (Json) | **184 μs** | .NET 9 |
| 4 线程并发读 | **6.8 μs** | .NET 9 |
| GetSection | **20 ns** | .NET 9 |
| ToMicrosoftConfiguration | **63 ns** | .NET 9 |
| 简单对象绑定 | **351 ns** | .NET 9 |
| Scoped 解析 | **8 ns** | .NET 9 |

### 测试问题记录

以下测试存在问题，未能正常完成：
- `BatchOperationBenchmarks.Get_Typed_Loop_10Keys` - 所有运行时版本
- `MultiSourceBenchmarks.Write_NewKey` - 所有运行时版本
- `MultiSourceBenchmarks.Write_OverrideKey` - 所有运行时版本

---

## 与上次测试对比

相比 2025-12-25_151849 的测试结果：

1. **新增测试项**：
   - DependencyInjectionBenchmarks（依赖注入测试）
   - EncodingBenchmarks（编码测试）
   - ObjectBinderBenchmarks（对象绑定测试）

2. **性能变化**：
   - 基本读写性能保持稳定
   - 大文件加载 Json 超越 Ini 成为最快格式
   - 批量操作中循环 Get 比 GetMany 更快（与之前结论相反）

3. **测试覆盖面更广**：
   - 增加了依赖注入场景的性能测试
   - 增加了多种编码格式的支持测试
   - 增加了对象绑定的性能测试
