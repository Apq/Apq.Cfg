# Apq.Cfg 性能测试结果

**测试环境**：

- 系统：Windows 11
- SDK：.NET SDK 9.0.308
- 测试运行时：.NET 6.0.36、.NET 8.0.22、.NET 9.0.11
- 测试日期：2025-12-25

---

## 1. 读写基准测试 (ReadWriteBenchmarks)

### 基本操作性能

| 操作 | .NET 9.0 | .NET 8.0 | .NET 6.0 | 说明 |
|------|----------|----------|----------|------|
| Get (字符串) | **16 ns** | 16 ns | 26 ns | 零内存分配 |
| Exists | **16 ns** | 16 ns | 26 ns | 零内存分配 |
| Set | **19 ns** | 19 ns | 26 ns | 零内存分配 |
| GetInt | **70 ns** | 75 ns | 164 ns | 类型转换 |

**结论**：

- 所有格式性能接近，差异在误差范围内
- **.NET 8/9 比 .NET 6 快约 38%**（基本操作）
- **.NET 9 类型转换比 .NET 6 快约 57%**
- 内存分配：.NET 9.0 (64B) < .NET 8.0 (88B) < .NET 6.0 (128B)

---

## 2. 大文件基准测试 (LargeFileBenchmarks)

### 1000 条配置项加载性能

| 格式 | .NET 9.0 | .NET 8.0 | .NET 6.0 | 内存 |
|------|----------|----------|----------|------|
| **Ini** | **197 μs** | 198 μs | 251 μs | 318 KB |
| **Json** | **252 μs** | 257 μs | 267 μs | 380 KB |
| Xml | 633 μs | 527 μs | 571 μs | 1,160 KB |
| Yaml | 849 μs | 974 μs | 1,217 μs | 1,275 KB |
| Toml | 906 μs | 948 μs | 1,200 μs | 2,364 KB |

**结论**：

- **Ini 和 Json 是大文件场景的最佳选择**
- Ini 比 Json 快约 22%，内存少 16%
- Toml 内存占用最高（约为 Json 的 6 倍）
- .NET 9 在 Yaml/Toml 解析上比 .NET 6 快约 25-30%

---

## 3. 并发基准测试 (ConcurrencyBenchmarks)

### 4 线程并发（Json 配置源）

| 操作 | .NET 9.0 | .NET 8.0 | .NET 6.0 |
|------|----------|----------|----------|
| 读相同键 | **2.9 μs** | 2.9 μs | 5.7 μs |
| 读不同键 | **3.2 μs** | 3.3 μs | 6.2 μs |
| Exists | **4.6 μs** | 4.5 μs | 12.1 μs |
| 混合读写 | **11.7 μs** | 16.2 μs | 22.2 μs |
| 写不同键 | **14.8 μs** | 18.9 μs | 25.2 μs |
| 写相同键 | **38.0 μs** | 42.0 μs | 43.8 μs |

**结论**：

- 并发读性能优秀，.NET 8/9 比 .NET 6 快约 50%
- 混合读写场景 .NET 9 比 .NET 6 快约 47%
- 线程安全，支持高并发访问

---

## 4. 缓存效果测试 (CacheBenchmarks)

| 场景 | .NET 9.0 | .NET 8.0 | .NET 6.0 |
|------|----------|----------|----------|
| 热路径读取 (1000次) | **13.7 μs** | 12.9 μs | 21.1 μs |
| 首次访问 | **15 ns** | 15 ns | 23 ns |
| 后续访问 (预热后) | **1.4 μs** | 1.5 μs | 2.4 μs |
| 缓存未命中 (1000次) | **13.6 μs** | 12.7 μs | 22.2 μs |

**结论**：

- 热路径读取性能稳定，.NET 8/9 比 .NET 6 快约 35%
- 首次访问仅需 15 ns，几乎无开销
- 缓存命中与未命中性能差异小，设计合理

---

## 5. 类型转换测试 (TypeConversionBenchmarks)

| 类型 | .NET 9.0 | .NET 8.0 | .NET 6.0 | 内存 (.NET 9) |
|------|----------|----------|----------|---------------|
| String | **18 ns** | 19 ns | 25 ns | 0 B |
| Int | **88 ns** | 74 ns | 143 ns | 64 B |
| Bool | **66 ns** | 94 ns | 107 ns | 64 B |
| Double | **121 ns** | 104 ns | 140 ns | 64 B |
| Guid | **80 ns** | 115 ns | 161 ns | 72 B |
| DateTime | **135 ns** | 203 ns | 209 ns | 64 B |
| Enum | **93 ns** | 157 ns | 240 ns | 64 B |

**结论**：

- .NET 9 在复杂类型转换上优势明显
- Enum 转换 .NET 9 比 .NET 6 快约 61%
- DateTime 转换 .NET 9 比 .NET 6 快约 35%
- 内存分配持续优化：.NET 9 (64B) < .NET 8 (88B) < .NET 6 (128B)

---

## 性能总结

### 性能排名（综合）

1. **Json** - 综合最优，平衡性好
2. **Ini** - 大文件场景最快，内存最省
3. **Xml** - 中等性能
4. **Yaml** - 较慢但可接受
5. **Toml** - 最慢，内存占用最高

### 运行时建议

- **推荐 .NET 8.0 或 .NET 9.0**，性能比 .NET 6.0 提升 35-60%
- 内存分配优化显著，GC 压力更小
- .NET 9 在类型转换和并发场景优势明显

### 使用建议

| 场景 | 推荐格式 | 说明 |
|------|----------|------|
| 高频读写 | Json / Ini | 单次操作 16-20 ns |
| 大配置文件 | Ini / Json | Ini 内存最省 |
| 人类可读性优先 | Yaml / Toml | 性能可接受 |
| 与现有系统集成 | Xml | 兼容性好 |
