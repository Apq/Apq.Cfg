import{d as ye,c as B,u as ge,g as w,h as we,E as f,i as G,b as o,e as k,j as ke,w as l,r as n,k as $e,a as h,f as m,t as U,F as xe,p as he,n as E,q as Ce,m as Ve,o as $}from"./index-DvA1iGEF.js";import{u as be}from"./apps-ko24tNTa.js";import{r as p}from"./request-D0JHu2Jz.js";import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Se=d=>({getMerged(){return p.get(`/api/proxy/${d}/merged`)},getMergedTree(){return p.get(`/api/proxy/${d}/merged/tree`)},getMergedValue(a){return p.get(`/api/proxy/${d}/merged/keys/${encodeURIComponent(a)}`)},getSources(){return p.get(`/api/proxy/${d}/sources`)},getSourceConfig(a,i){return p.get(`/api/proxy/${d}/sources/${a}/${encodeURIComponent(i)}`)},getSourceTree(a,i){return p.get(`/api/proxy/${d}/sources/${a}/${encodeURIComponent(i)}/tree`)},getSourceValue(a,i,y){return p.get(`/api/proxy/${d}/sources/${a}/${encodeURIComponent(i)}/keys/${encodeURIComponent(y)}`)},setValue(a,i){return p.put(`/api/proxy/${d}/keys/${encodeURIComponent(a)}`,i)},setSourceValue(a,i,y,b){return p.put(`/api/proxy/${d}/sources/${a}/${encodeURIComponent(i)}/keys/${encodeURIComponent(y)}`,b)},deleteKey(a){return p.delete(`/api/proxy/${d}/keys/${encodeURIComponent(a)}`)},deleteSourceKey(a,i,y){return p.delete(`/api/proxy/${d}/sources/${a}/${encodeURIComponent(i)}/keys/${encodeURIComponent(y)}`)},save(){return p.post(`/api/proxy/${d}/save`)},reload(){return p.post(`/api/proxy/${d}/reload`)},export(a="json"){return p.get(`/api/proxy/${d}/export/${a}`,{responseType:"text"})},exportSource(a,i,y="json"){return p.get(`/api/proxy/${d}/sources/${a}/${encodeURIComponent(i)}/export/${y}`,{responseType:"text"})}}),Ue={class:"config-container"},Ke={class:"header-left"},Me={class:"app-name"},Le={class:"header-right"},Te={class:"source-tabs"},Ae={class:"card-header"},Ne={class:"tree-node"},De=ye({__name:"ConfigView",setup(d){const a=ge(),i=Ve(),y=be(),b=B(()=>a.params.id),j=w(null),v=B(()=>Se(b.value)),K=w(!1),M=w(!1),L=w(!1),I=w([]),g=w("merged"),T=w([]),R=w(""),u=w(null),C=w(""),H=B(()=>R.value?F(T.value,R.value.toLowerCase()):T.value);function F(t,e){return t.reduce((r,s)=>{const _=s.fullKey.toLowerCase().includes(e),x=s.children?F(s.children,e):[];return(_||x.length>0)&&r.push({...s,children:x.length>0?x:s.children}),r},[])}we(async()=>{await y.fetchApps(),j.value=y.apps.find(t=>t.id===b.value)||null,await Q(),await V()});async function Q(){try{const t=await v.value.getSources();t.success&&t.data&&(I.value=t.data)}catch(t){console.error("Failed to load sources",t)}}async function V(){K.value=!0,u.value=null;try{let t;if(g.value==="merged")t=await v.value.getMergedTree();else{const[e,r]=g.value.split("/");t=await v.value.getSourceTree(parseInt(e),r)}t.success&&t.data&&(T.value=O(t.data.children||[],""))}catch{f.error("加载配置失败")}finally{K.value=!1}}function O(t,e){return t.map(r=>{const s=e?`${e}:${r.key}`:r.key;return{...r,fullKey:s,children:r.children?O(r.children,s):[]}})}function X(t){t.hasValue&&(u.value=t,C.value=t.value||"")}async function Y(){if(u.value)try{let t;if(g.value==="merged")t=await v.value.setValue(u.value.fullKey,C.value);else{const[e,r]=g.value.split("/");t=await v.value.setSourceValue(parseInt(e),r,u.value.fullKey,C.value)}t.success?(f.success("更新成功"),await V()):f.error(t.error||"更新失败")}catch{f.error("更新失败")}}async function Z(){if(u.value)try{await Ce.confirm(`确定要删除配置 "${u.value.fullKey}" 吗？`,"确认删除",{type:"warning"});let t;if(g.value==="merged")t=await v.value.deleteKey(u.value.fullKey);else{const[e,r]=g.value.split("/");t=await v.value.deleteSourceKey(parseInt(e),r,u.value.fullKey)}t.success?(f.success("删除成功"),u.value=null,await V()):f.error(t.error||"删除失败")}catch{}}async function ee(){M.value=!0;try{const t=await v.value.save();t.success?f.success("保存成功"):f.error(t.error||"保存失败")}catch{f.error("保存失败")}finally{M.value=!1}}async function te(){L.value=!0;try{const t=await v.value.reload();t.success?(f.success("刷新成功"),await V()):f.error(t.error||"刷新失败")}catch{f.error("刷新失败")}finally{L.value=!1}}async function le(t){try{let e;if(g.value==="merged")e=await v.value.export(t);else{const[x,A]=g.value.split("/");e=await v.value.exportSource(parseInt(x),A,t)}const r=new Blob([e],{type:"text/plain"}),s=URL.createObjectURL(r),_=document.createElement("a");_.href=s,_.download=`config.${t==="kv"?"txt":t}`,_.click(),URL.revokeObjectURL(s)}catch{f.error("导出失败")}}function oe(){i.push("/")}return(t,e)=>{const r=n("ArrowLeft"),s=n("el-icon"),_=n("el-button"),x=n("Refresh"),A=n("Check"),ne=n("ArrowDown"),N=n("el-dropdown-item"),ae=n("el-dropdown-menu"),re=n("el-dropdown"),se=n("el-header"),q=n("el-radio-button"),z=n("el-tag"),ue=n("el-radio-group"),ce=n("Search"),D=n("el-input"),de=n("Lock"),ie=n("el-tree"),J=n("el-card"),P=n("el-col"),S=n("el-form-item"),pe=n("el-form"),fe=n("el-empty"),me=n("el-row"),_e=n("el-main"),ve=$e("loading");return $(),G("div",Ue,[o(se,{class:"header"},{default:l(()=>{var c;return[k("div",Ke,[o(_,{text:"",onClick:oe},{default:l(()=>[o(s,null,{default:l(()=>[o(r)]),_:1}),e[3]||(e[3]=m(" 返回 ",-1))]),_:1}),k("span",Me,U(((c=j.value)==null?void 0:c.name)||"加载中..."),1)]),k("div",Le,[o(_,{onClick:te,loading:L.value},{default:l(()=>[o(s,null,{default:l(()=>[o(x)]),_:1}),e[4]||(e[4]=m(" 刷新 ",-1))]),_:1},8,["loading"]),o(_,{type:"primary",onClick:ee,loading:M.value},{default:l(()=>[o(s,null,{default:l(()=>[o(A)]),_:1}),e[5]||(e[5]=m(" 保存 ",-1))]),_:1},8,["loading"]),o(re,{onCommand:le},{dropdown:l(()=>[o(ae,null,{default:l(()=>[o(N,{command:"json"},{default:l(()=>[...e[7]||(e[7]=[m("JSON",-1)])]),_:1}),o(N,{command:"env"},{default:l(()=>[...e[8]||(e[8]=[m("ENV",-1)])]),_:1}),o(N,{command:"kv"},{default:l(()=>[...e[9]||(e[9]=[m("Key-Value",-1)])]),_:1})]),_:1})]),default:l(()=>[o(_,null,{default:l(()=>[e[6]||(e[6]=m(" 导出 ",-1)),o(s,{class:"el-icon--right"},{default:l(()=>[o(ne)]),_:1})]),_:1})]),_:1})])]}),_:1}),k("div",Te,[o(ue,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=c=>g.value=c),onChange:V},{default:l(()=>[o(q,{value:"merged"},{default:l(()=>[...e[10]||(e[10]=[m("合并后",-1)])]),_:1}),($(!0),G(xe,null,he(I.value,c=>($(),h(q,{key:`${c.level}-${c.name}`,value:`${c.level}/${c.name}`},{default:l(()=>[m(U(c.name)+" ("+U(c.level)+") ",1),c.isPrimaryWriter?($(),h(z,{key:0,size:"small",type:"success",style:{"margin-left":"5px"}},{default:l(()=>[...e[11]||(e[11]=[m("主写入",-1)])]),_:1})):E("",!0)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),ke(($(),h(_e,{class:"main"},{default:l(()=>[o(me,{gutter:20},{default:l(()=>[o(P,{span:10},{default:l(()=>[o(J,{class:"tree-card"},{header:l(()=>[k("div",Ae,[e[12]||(e[12]=k("span",null,"配置树",-1)),o(D,{modelValue:R.value,"onUpdate:modelValue":e[1]||(e[1]=c=>R.value=c),placeholder:"搜索配置...",clearable:"",style:{width:"200px"}},{prefix:l(()=>[o(s,null,{default:l(()=>[o(ce)]),_:1})]),_:1},8,["modelValue"])])]),default:l(()=>[o(ie,{data:H.value,props:{label:"key",children:"children"},"node-key":"fullKey","default-expand-all":"","highlight-current":"",onNodeClick:X},{default:l(({node:c,data:W})=>[k("span",Ne,[k("span",null,U(W.key),1),W.isMasked?($(),h(s,{key:0,class:"masked-icon"},{default:l(()=>[o(de)]),_:1})):E("",!0)])]),_:1},8,["data"])]),_:1})]),_:1}),o(P,{span:14},{default:l(()=>[u.value?($(),h(J,{key:0,class:"detail-card"},{header:l(()=>[...e[13]||(e[13]=[k("span",null,"配置详情",-1)])]),default:l(()=>[o(pe,{"label-width":"80px"},{default:l(()=>[o(S,{label:"键"},{default:l(()=>[o(D,{value:u.value.fullKey,readonly:""},null,8,["value"])]),_:1}),o(S,{label:"值"},{default:l(()=>[o(D,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=c=>C.value=c),type:"textarea",rows:4,disabled:u.value.isMasked,placeholder:u.value.isMasked?"敏感值已脱敏":""},null,8,["modelValue","disabled","placeholder"])]),_:1}),u.value.isMasked?($(),h(S,{key:0},{default:l(()=>[o(z,{type:"warning"},{default:l(()=>[...e[14]||(e[14]=[m("此值已脱敏，无法编辑",-1)])]),_:1})]),_:1})):E("",!0),o(S,null,{default:l(()=>[o(_,{type:"primary",onClick:Y,disabled:u.value.isMasked},{default:l(()=>[...e[15]||(e[15]=[m(" 更新 ",-1)])]),_:1},8,["disabled"]),o(_,{type:"danger",onClick:Z,disabled:u.value.isMasked},{default:l(()=>[...e[16]||(e[16]=[m(" 删除 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})):($(),h(fe,{key:1,description:"点击左侧配置项查看详情"}))]),_:1})]),_:1})]),_:1})),[[ve,K.value]])])}}}),Fe=Re(De,[["__scopeId","data-v-3ed33f6b"]]);export{Fe as default};
