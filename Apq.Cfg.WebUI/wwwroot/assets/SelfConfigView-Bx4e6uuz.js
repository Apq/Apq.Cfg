import{r as f}from"./request-D0JHu2Jz.js";import{d as oe,g as i,c as re,h as se,E as c,i as R,e as p,j as ue,b as n,w as l,r as a,k as ce,f as d,F as de,p as ie,a as h,n as A,t as b,o as _}from"./index-DvA1iGEF.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const v={getSources(){return f.get("/api/apqcfg/sources")},getMergedTree(){return f.get("/api/apqcfg/merged/tree")},getSourceTree(g,m){return f.get(`/api/apqcfg/sources/${g}/${encodeURIComponent(m)}/tree`)},getMergedConfig(){return f.get("/api/apqcfg/merged")},setValue(g,m){return f.put(`/api/apqcfg/keys/${g}`,m,{headers:{"Content-Type":"application/json"}})},save(){return f.post("/api/apqcfg/save")},reload(){return f.post("/api/apqcfg/reload")},export(g){return f.get(`/api/apqcfg/export/${g}`,{responseType:"text"})}},fe={class:"self-config-container"},_e={class:"page-header"},me={class:"header-actions"},ve={class:"source-tabs"},ge={class:"main-content"},ye={class:"card-header"},we={class:"tree-node"},he=oe({__name:"SelfConfigView",setup(g){const m=i(!1),S=i(!1),$=i(!1),D=i([]),k=i("merged"),T=i([]),V=i(""),y=i(null),C=i(""),F=re(()=>V.value?K(T.value,V.value.toLowerCase()):T.value);function K(t,e){return t.reduce((r,s)=>{const u=s.fullKey.toLowerCase().includes(e),w=s.children?K(s.children,e):[];return(u||w.length>0)&&r.push({...s,children:w.length>0?w:s.children}),r},[])}function I(t){return t?t.length>20?t.substring(0,20)+"...":t:""}se(async()=>{await O(),await x()});async function O(){try{const t=await v.getSources();t.success&&t.data&&(D.value=t.data)}catch(t){console.error("Failed to load sources",t)}}async function x(){m.value=!0,y.value=null;try{let t;if(k.value==="merged")t=await v.getMergedTree();else{const[e,r]=k.value.split("/");t=await v.getSourceTree(parseInt(e),r)}t.success&&t.data&&(T.value=L(t.data.children||[],""))}catch{c.error("加载配置失败")}finally{m.value=!1}}function L(t,e){return t.map(r=>{const s=e?`${e}:${r.key}`:r.key,u=r.value!==void 0&&r.value!==null;return{...r,fullKey:s,hasValue:u,children:r.children?L(r.children,s):[]}})}function z(t){t.hasValue&&(y.value=t,C.value=t.value||"")}async function J(){if(y.value)try{const t=await v.setValue(y.value.fullKey,C.value);t.success?(c.success("更新成功"),await x()):c.error(t.error||"更新失败")}catch{c.error("更新失败")}}async function P(){S.value=!0;try{const t=await v.save();t.success?c.success("保存成功"):c.error(t.error||"保存失败")}catch{c.error("保存失败")}finally{S.value=!1}}async function W(){$.value=!0;try{const t=await v.reload();t.success?(c.success("刷新成功"),await x()):c.error(t.error||"刷新失败")}catch{c.error("刷新失败")}finally{$.value=!1}}async function G(t){try{const e=await v.export(t),r=new Blob([e],{type:"text/plain"}),s=URL.createObjectURL(r),u=document.createElement("a");u.href=s,u.download=`config.${t==="kv"?"txt":t}`,u.click(),URL.revokeObjectURL(s)}catch{c.error("导出失败")}}return(t,e)=>{const r=a("Refresh"),s=a("el-icon"),u=a("el-button"),w=a("Check"),H=a("ArrowDown"),q=a("el-dropdown-item"),Q=a("el-dropdown-menu"),X=a("el-dropdown"),E=a("el-radio-button"),j=a("el-tag"),Y=a("el-radio-group"),Z=a("Search"),N=a("el-input"),ee=a("el-tree"),B=a("el-card"),M=a("el-col"),U=a("el-form-item"),te=a("el-form"),le=a("el-empty"),ne=a("el-row"),ae=ce("loading");return _(),R("div",fe,[p("div",_e,[e[9]||(e[9]=p("h2",null,"本机配置",-1)),p("div",me,[n(u,{onClick:W,loading:$.value},{default:l(()=>[n(s,null,{default:l(()=>[n(r)]),_:1}),e[3]||(e[3]=d(" 刷新 ",-1))]),_:1},8,["loading"]),n(u,{type:"primary",onClick:P,loading:S.value},{default:l(()=>[n(s,null,{default:l(()=>[n(w)]),_:1}),e[4]||(e[4]=d(" 保存 ",-1))]),_:1},8,["loading"]),n(X,{onCommand:G},{dropdown:l(()=>[n(Q,null,{default:l(()=>[n(q,{command:"json"},{default:l(()=>[...e[6]||(e[6]=[d("JSON",-1)])]),_:1}),n(q,{command:"env"},{default:l(()=>[...e[7]||(e[7]=[d("ENV",-1)])]),_:1}),n(q,{command:"kv"},{default:l(()=>[...e[8]||(e[8]=[d("Key-Value",-1)])]),_:1})]),_:1})]),default:l(()=>[n(u,null,{default:l(()=>[e[5]||(e[5]=d(" 导出 ",-1)),n(s,{class:"el-icon--right"},{default:l(()=>[n(H)]),_:1})]),_:1})]),_:1})])]),p("div",ve,[n(Y,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=o=>k.value=o),onChange:x},{default:l(()=>[n(E,{value:"merged"},{default:l(()=>[...e[10]||(e[10]=[d("合并后",-1)])]),_:1}),(_(!0),R(de,null,ie(D.value,o=>(_(),h(E,{key:`${o.level}-${o.name}`,value:`${o.level}/${o.name}`},{default:l(()=>[d(b(o.name)+" ("+b(o.level)+") ",1),o.isPrimaryWriter?(_(),h(j,{key:0,size:"small",type:"success",style:{"margin-left":"5px"}},{default:l(()=>[...e[11]||(e[11]=[d("主写入",-1)])]),_:1})):A("",!0)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),ue((_(),R("div",ge,[n(ne,{gutter:20},{default:l(()=>[n(M,{span:10},{default:l(()=>[n(B,{class:"tree-card"},{header:l(()=>[p("div",ye,[e[12]||(e[12]=p("span",null,"配置树",-1)),n(N,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=o=>V.value=o),placeholder:"搜索配置...",clearable:"",style:{width:"200px"}},{prefix:l(()=>[n(s,null,{default:l(()=>[n(Z)]),_:1})]),_:1},8,["modelValue"])])]),default:l(()=>[n(ee,{data:F.value,props:{label:"key",children:"children"},"node-key":"fullKey","default-expand-all":"","highlight-current":"",onNodeClick:z},{default:l(({data:o})=>[p("span",we,[p("span",null,b(o.key),1),o.hasValue?(_(),h(j,{key:0,size:"small",type:"info",style:{"margin-left":"5px"}},{default:l(()=>[d(b(I(o.value)),1)]),_:2},1024)):A("",!0)])]),_:1},8,["data"])]),_:1})]),_:1}),n(M,{span:14},{default:l(()=>[y.value?(_(),h(B,{key:0,class:"detail-card"},{header:l(()=>[...e[13]||(e[13]=[p("span",null,"配置详情",-1)])]),default:l(()=>[n(te,{"label-width":"80px"},{default:l(()=>[n(U,{label:"键"},{default:l(()=>[n(N,{value:y.value.fullKey,readonly:""},null,8,["value"])]),_:1}),n(U,{label:"值"},{default:l(()=>[n(N,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=o=>C.value=o),type:"textarea",rows:4},null,8,["modelValue"])]),_:1}),n(U,null,{default:l(()=>[n(u,{type:"primary",onClick:J},{default:l(()=>[...e[14]||(e[14]=[d(" 更新 ",-1)])]),_:1})]),_:1})]),_:1})]),_:1})):(_(),h(le,{key:1,description:"点击左侧配置项查看详情"}))]),_:1})]),_:1})])),[[ae,m.value]])])}}}),xe=pe(he,[["__scopeId","data-v-fc13dc23"]]);export{xe as default};
