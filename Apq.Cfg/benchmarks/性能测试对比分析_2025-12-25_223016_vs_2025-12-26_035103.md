# Apq.Cfg 性能测试对比分析

**对比版本**：
- 第一次测试：2025-12-25_223016
- 第二次测试：2025-12-26_035103

**测试环境**（两次相同）：
- 系统：Windows 11 (10.0.26200.7462)
- SDK：.NET SDK 9.0.308
- 测试运行时：.NET 6.0.36、.NET 8.0.22、.NET 9.0.11
- CPU：支持 AVX-512F+CD+BW+DQ+VL+VBMI

---

## 一、测试覆盖范围对比

| 测试类别 | 第一次 (223016) | 第二次 (035103) | 变化 |
|----------|:---------------:|:---------------:|------|
| ReadWriteBenchmarks | ✓ | ✓ | 无变化 |
| LargeFileBenchmarks | ✓ | ✓ | 无变化 |
| ConcurrencyBenchmarks | ✓ | ✓ | 无变化 |
| CacheBenchmarks | ✓ | ✓ | 无变化 |
| TypeConversionBenchmarks | ✓ | ✓ | 无变化 |
| BatchOperationBenchmarks | ✓ | ✓ | 无变化 |
| GetSectionBenchmarks | ✓ | ✓ | 无变化 |
| SaveBenchmarks | ✓ | ✓ | 无变化 |
| RemoveBenchmarks | ✓ | ✓ | 无变化 |
| MultiSourceBenchmarks | ✓ | ✓ | 无变化 |
| KeyPathBenchmarks | ✓ | ✓ | 无变化 |
| MicrosoftConfigBenchmarks | ✓ | ✓ | 无变化 |
| DependencyInjectionBenchmarks | ✓ | ✓ | 无变化 |
| EncodingBenchmarks | ✓ | ✓ | 无变化 |
| ObjectBinderBenchmarks | ✓ | ✓ | 无变化 |
| **SourceGeneratorBenchmarks** | ✗ | ✓ | **新增** |

---

## 二、核心性能指标对比（.NET 9.0）

### 1. 读写基准测试 (ReadWriteBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| Get (字符串) | 17-19 ns | 21-22 ns | +15% | 略有波动 |
| Exists | 22 ns | 23 ns | +5% | 稳定 |
| Set | 22 ns | 23 ns | +5% | 稳定 |
| GetInt | 82-86 ns | 90-95 ns | +10% | 略有波动 |

**结论**：基本读写性能保持稳定，差异在正常波动范围内。

---

### 2. 大文件基准测试 (LargeFileBenchmarks)

| 格式 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| Json (1000键) | 241 μs | 307 μs | **+27%** | 性能下降 |
| Ini (1000键) | 184 μs | 224 μs | **+22%** | 性能下降 |
| Xml (5000键) | 460 μs | 620 μs | **+35%** | 性能下降 |
| Yaml (5000键) | 836 μs | 1,078 μs | **+29%** | 性能下降 |
| Toml (5000键) | 1,474 μs | 1,187 μs | **-19%** | 性能提升 |

**重要发现**：
- 大文件加载性能整体有所下降
- Toml 格式性能反而有所提升
- 可能与测试时的磁盘 I/O 状态有关

---

### 3. 并发基准测试 (ConcurrencyBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 读相同键 (4线程) | 6.78 μs | 7.03 μs | +4% | 稳定 |
| 读不同键 (4线程) | 16.74 μs | 19.48 μs | +16% | 略有波动 |
| Exists (4线程) | 3.95 μs | 2.94 μs | **-26%** | 性能提升 |
| 混合读写 (4线程) | 4.26 μs | 3.09 μs | **-27%** | 性能提升 |
| 写不同键 (16线程) | 32.04 μs | 35.75 μs | +12% | 略有波动 |
| 高并发读取 (16线程) | 18.27 μs | 14.75 μs | **-19%** | 性能提升 |

**结论**：混合读写和高并发读取性能显著提升，纯写入操作略有波动。

---

### 4. 缓存效果测试 (CacheBenchmarks)

| 场景 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 热路径读取 (1000次) | 15.6 μs | 13.7 μs | **-12%** | 性能提升 |
| 首次访问 | 16 ns | 15 ns | -6% | 稳定 |
| 后续访问 (预热后) | 1.7 μs | 1.5 μs | **-12%** | 性能提升 |
| 缓存未命中 (1000次) | 3.7 μs | 3.4 μs | **-8%** | 性能提升 |
| 写后读取 | 155 μs | 180 μs | +16% | 略有波动 |

**结论**：缓存性能整体有所提升，首次读取和缓存命中都有约 12% 的改善。

---

### 5. 类型转换测试 (TypeConversionBenchmarks)

| 类型 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| String | 18 ns | 20 ns | +11% | 略有波动 |
| Int | 67 ns | 77 ns | +15% | 略有波动 |
| Bool | 87 ns | 94 ns | +8% | 稳定 |
| Double | 94 ns | 107 ns | +14% | 略有波动 |
| Guid | 112 ns | 128 ns | +14% | 略有波动 |
| DateTime | 128 ns | 136 ns | +6% | 稳定 |
| Enum | 76 ns | 85 ns | +12% | 略有波动 |
| NullableInt | 77 ns | 84 ns | +9% | 稳定 |

**结论**：类型转换性能略有下降，但差异在 10-20 ns 范围内，实际影响很小。

---

### 6. 批量操作测试 (BatchOperationBenchmarks)

#### 6.1 GetMany 返回字典版本（有堆分配）

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| GetMany (10键) | 346 ns | 311 ns | **-10%** | 性能提升 |
| GetMany (50键) | 1,595 ns | 1,448 ns | **-9%** | 性能提升 |
| GetMany (100键) | 3,474 ns | 3,034 ns | **-13%** | 性能提升 |

#### 6.2 GetMany 回调版本（零堆分配，高性能）- 第二次测试新增

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 | 说明 |
|------|----------|----------|----------|------|
| GetMany_Callback (10键) | 276 ns | 157 ns | **157 ns** | 零堆分配 |
| GetMany_Callback (50键) | 1,349 ns | 811 ns | **820 ns** | 零堆分配 |
| GetMany_Callback (100键) | 2,677 ns | 1,670 ns | **1,643 ns** | 零堆分配 |

#### 6.3 GetMany 两种重载对比（.NET 9.0）

| 操作 | 返回字典版本 | 回调版本 | 回调版本提升 | 说明 |
|------|-------------|---------|-------------|------|
| 10 键 | 311 ns | 157 ns | **-50%** | 回调版本快 2 倍 |
| 50 键 | 1,448 ns | 820 ns | **-43%** | 回调版本快 1.8 倍 |
| 100 键 | 3,034 ns | 1,643 ns | **-46%** | 回调版本快 1.8 倍 |

#### 6.4 Get 循环 vs GetMany 对比

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| Get 循环 (10键) | 167 ns | 150 ns | **-10%** | 性能提升 |
| Get 循环 (50键) | 855 ns | 787 ns | **-8%** | 性能提升 |
| Get 循环 (100键) | 1,833 ns | 1,685 ns | **-8%** | 性能提升 |

#### 6.5 SetMany 测试

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| SetMany (10键) | 373 ns | 157 ns | **-58%** | 显著提升 |

**重要发现**：
- 批量操作性能整体有所提升
- SetMany 性能提升最为显著（58%）
- **GetMany 回调版本比返回字典版本快约 43-50%**（零堆分配）
- 两次测试都显示：循环 Get 比 GetMany（返回字典版本）更快
- **推荐**：高频调用场景使用 `GetMany(keys, onValue)` 回调版本

---

### 7. 配置节测试 (GetSectionBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| GetSection | 20 ns | 18 ns | **-10%** | 性能提升 |
| GetSection (嵌套) | 34 ns | 29 ns | **-15%** | 性能提升 |
| GetChildKeys (5键) | 1.0 μs | 0.9 μs | **-10%** | 性能提升 |
| 直接 Get | 4 ns | 4 ns | ≈ | 稳定 |
| Section.Get | 15 ns | 13 ns | **-13%** | 性能提升 |
| Section.GetChildKeys | 0.43 μs | 0.46 μs | +7% | 稳定 |

**结论**：配置节操作性能整体有所提升。

---

### 8. 保存测试 (SaveBenchmarks)

| 格式 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| Json (10项) | 3.8 ms | 3.7 ms | -3% | 稳定 |
| Ini (10项) | 0.77 ms | 0.85 ms | +10% | 略有波动 |
| Xml (10项) | 0.68 ms | 0.79 ms | +16% | 略有波动 |
| Yaml (10项) | 0.76 ms | 0.80 ms | +5% | 稳定 |
| Toml (10项) | 0.97 ms | 1.03 ms | +6% | 稳定 |

**结论**：保存性能整体稳定，部分格式略有波动。

---

### 9. 删除测试 (RemoveBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 单键删除 | 5.2 μs | 4.9 μs | **-6%** | 性能提升 |
| 批量删除 (10键) | 7.2 μs | 7.2 μs | ≈ | 稳定 |
| 删除不存在的键 | 7.2 μs | 7.3 μs | +1% | 稳定 |
| 删除后保存 | 0.88 ms | 0.89 ms | +1% | 稳定 |

**结论**：删除操作性能稳定。

---

### 10. 多源合并测试 (MultiSourceBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 读高优先级键 | 45 ns | 50 ns | +11% | 略有波动 |
| 读低优先级键 | 48 ns | 53 ns | +10% | 略有波动 |
| 读共享键 | 46 ns | 48 ns | +4% | 稳定 |
| 批量读取 | 11.1 μs | 11.6 μs | +5% | 稳定 |
| Exists | 49 ns | 52 ns | +6% | 稳定 |
| 类型转换 | 108 ns | 116 ns | +7% | 稳定 |
| Write_NewKey | NA | 6.6 μs | - | **已修复** |
| Write_OverrideKey | NA | 3.8 μs | - | **已修复** |

**重要发现**：第一次测试中写入测试存在问题，第二次测试已修复。

---

### 11. 键路径深度测试 (KeyPathBenchmarks)

| 路径深度 | 第一次 | 第二次 | 变化 | 说明 |
|----------|--------|--------|------|------|
| 深度 1 | 14 ns | 14 ns | ≈ | 稳定 |
| 深度 5 | 26 ns | 28 ns | +8% | 稳定 |
| 深度 10 | 23 ns | 27 ns | +17% | 略有波动 |
| 深度 5 (Int) | 100 ns | 125 ns | +25% | 波动较大 |
| 深度 5 (Bool) | 94 ns | 143 ns | +52% | 波动较大 |

**结论**：基础键路径测试稳定，类型转换路径波动较大。

---

### 12. Microsoft Configuration 转换测试 (MicrosoftConfigBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| ToMicrosoftConfiguration (静态) | 63 ns | 79 ns | +25% | 波动较大 |
| ToMicrosoftConfiguration (动态) | 95 ns | 110 ns | +16% | 略有波动 |
| ToMicrosoftConfiguration (多次) | 970 ns | 1,141 ns | +18% | 略有波动 |
| 通过 ApqCfg 读取 | 18 ns | 20 ns | +11% | 略有波动 |
| 通过 MsConfig 读取 | 12 ns | 13 ns | +8% | 稳定 |
| 订阅 ConfigChanges | 5.5 μs | 5.9 μs | +7% | 稳定 |
| 触发变更 | 3.3 μs | 3.8 μs | +15% | 略有波动 |

**结论**：Microsoft Configuration 转换性能略有波动，但整体稳定。

---

### 13. 依赖注入测试 (DependencyInjectionBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 解析 IApqCfg | 142 μs | 123 μs | **-13%** | 性能提升 |
| 解析 IApqCfg (Scoped) | 8 ns | 6 ns | **-25%** | 性能提升 |
| 解析 IApqCfgSection | 0.67 μs | 0.61 μs | **-9%** | 性能提升 |
| 解析 IApqCfgSection (Scoped) | 12 ns | 12 ns | ≈ | 稳定 |
| 解析 Options<T> | 0.82 μs | 0.82 μs | ≈ | 稳定 |
| 解析 IOptionsSnapshot<T> | 0.27 μs | 0.23 μs | **-15%** | 性能提升 |
| 解析 IOptionsMonitor<T> | 27 μs | 25 μs | **-7%** | 性能提升 |

**亮点**：依赖注入性能整体有所提升，Scoped 解析仅需 6-12 ns，性能极佳。

---

### 14. 编码测试 (EncodingBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 加载 UTF-8 文件 | 39 μs | 30 μs | **-23%** | 性能提升 |
| 加载 UTF-8 BOM 文件 | 39 μs | 30 μs | **-23%** | 性能提升 |
| 加载 UTF-16 文件 | 151 μs | 117 μs | **-23%** | 性能提升 |
| 加载 GB2312 文件 | 142 μs | 116 μs | **-18%** | 性能提升 |
| 保存 UTF-8 文件 | 35 ms | 30 ms | **-14%** | 性能提升 |
| 保存 UTF-8 BOM 文件 | 15 ms | 14 ms | **-7%** | 性能提升 |
| 读取中文值 (预热后) | 1.4 μs | 1.2 μs | **-14%** | 性能提升 |

**亮点**：编码相关操作性能全面提升，UTF-8 加载提升 23%。

---

### 15. 对象绑定测试 (ObjectBinderBenchmarks)

| 操作 | 第一次 | 第二次 | 变化 | 说明 |
|------|--------|--------|------|------|
| 绑定简单对象 | 351 ns | 392 ns | +12% | 略有波动 |
| 绑定嵌套对象 | 1.6 μs | 2.0 μs | +25% | 波动较大 |
| 绑定集合 | 2.2 μs | 2.6 μs | +18% | 略有波动 |
| 绑定字典 | 1.3 μs | 1.5 μs | +15% | 略有波动 |
| 绑定复杂对象 | 33 μs | 39 μs | +18% | 略有波动 |
| 绑定复杂对象 (反射) | 162 μs | 194 μs | +20% | 波动较大 |

**结论**：对象绑定性能有所下降，但仍在可接受范围内。

---

## 三、新增测试项（第二次测试）

### 16. 源生成器测试 (SourceGeneratorBenchmarks)

| 操作 | .NET 6.0 | .NET 8.0 | .NET 9.0 |
|------|----------|----------|----------|
| 生成器绑定 (简单) | 3.7 μs | 2.2 μs | **2.1 μs** |
| 生成器绑定 (嵌套) | 4.7 μs | 2.7 μs | **2.7 μs** |
| 反射绑定 (简单) | 344 μs | 204 μs | **204 μs** |
| 反射绑定 (嵌套) | 455 μs | 267 μs | **267 μs** |
| 直接读取 (生成器) | 299 ns | 197 ns | **195 ns** |
| 直接读取 (反射) | 929 ns | 384 ns | **374 ns** |

**亮点**：
- 源生成器比反射快约 **100 倍**（绑定操作）
- .NET 8/9 比 .NET 6 快约 **40%**
- 直接读取操作，生成器比反射快约 **2 倍**

---

## 四、测试问题记录

### 第一次测试中发现的问题（第二次已修复）

| 测试方法 | 问题原因 | 修复状态 |
|----------|----------|----------|
| `BatchOperationBenchmarks.Get_Typed_Loop_10Keys` | 配置值为 "Value0" 无法转换为 int | ✓ 已修复 |
| `MultiSourceBenchmarks.Write_NewKey` | 最高层级配置源不可写 | ✓ 已修复 |
| `MultiSourceBenchmarks.Write_OverrideKey` | 最高层级配置源不可写 | ✓ 已修复 |

---

## 五、总结

### 性能稳定性评估

| 类别 | 稳定性 | 说明 |
|------|--------|------|
| 基本读写 | ⭐⭐⭐⭐⭐ | 非常稳定，波动 <15% |
| 并发操作 | ⭐⭐⭐⭐ | 稳定，混合读写性能提升 |
| 缓存效果 | ⭐⭐⭐⭐⭐ | 非常稳定，性能提升 12% |
| 类型转换 | ⭐⭐⭐⭐ | 稳定，波动 <15% |
| 大文件加载 | ⭐⭐⭐ | 有波动，可能与 I/O 状态有关 |
| 保存操作 | ⭐⭐⭐⭐ | 稳定，波动 <16% |
| 删除操作 | ⭐⭐⭐⭐⭐ | 非常稳定 |
| 配置节操作 | ⭐⭐⭐⭐⭐ | 非常稳定，性能提升 10-15% |
| 键路径深度 | ⭐⭐⭐ | 类型转换路径波动较大 |
| Microsoft 转换 | ⭐⭐⭐⭐ | 稳定，波动 <25% |
| 依赖注入 | ⭐⭐⭐⭐⭐ | 非常稳定，性能提升 |
| 编码操作 | ⭐⭐⭐⭐⭐ | 非常稳定，性能提升 14-23% |
| 对象绑定 | ⭐⭐⭐ | 有波动，下降 12-25% |

### 主要发现

1. **性能提升的方面**：
   - 批量操作 GetMany/SetMany 提升 8-58%
   - 缓存性能提升约 12%
   - 混合并发读写提升 26-27%
   - 高并发读取提升 19%
   - 配置节操作提升 10-15%
   - 依赖注入性能提升 7-25%
   - 编码操作提升 14-23%

2. **性能下降的方面**：
   - 大文件加载下降 22-35%
   - 对象绑定下降 12-25%
   - 键路径类型转换波动较大

3. **新增测试覆盖**：
   - 源生成器性能测试：比反射快约 100 倍
   - **GetMany 回调版本测试**：比返回字典版本快 43-50%（零堆分配）
   - 修复了之前的测试问题

4. **运行时建议不变**：
   - 推荐 .NET 8.0 或 .NET 9.0
   - 性能比 .NET 6.0 提升 35-55%

### 建议

1. **性能测试应多次运行取平均值**，减少单次测试的波动影响
2. **关注大文件加载性能波动**，在生产环境中注意 I/O 状态
3. **优先使用源生成器**，在对象绑定场景获得最佳性能
4. **利用 Scoped 解析**，在依赖注入场景获得最佳性能（6-12 ns）
5. **优先使用 Json 或 Ini 格式**，性能最稳定
6. **高频批量读取使用 GetMany 回调版本**，比返回字典版本快 43-50%，且零堆分配
